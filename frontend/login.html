<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICASV - Login Administrativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: var(--bs-body-bg);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            transition: background-color 0.3s;
        }
        .card-login { width: 100%; max-width: 400px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 1rem; overflow: hidden; }
        .login-header { background: linear-gradient(45deg, #198754, #20c997); color: white; text-align: center; padding: 30px 20px; }
        .form-control:focus { box-shadow: none; border-color: #dc3545; }
        .input-group-text { background-color: transparent; }
        .theme-toggle { position: absolute; top: 20px; right: 20px; }
    </style>
</head>
<body>

    <button class="btn btn-outline-secondary rounded-circle theme-toggle" onclick="toggleTheme()" id="btnTheme"><i class="fas fa-moon"></i></button>

    <div class="card card-login">
        <div class="login-header">
            <h4 class="mb-0"><i class="fas fa-lock"></i> Acesso Restrito</h4>
        </div>
        <div class="card-body p-4">
            <form id="formLogin">
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <div class="input-group">
                        <span class="input-group-text text-muted"><i class="fas fa-envelope"></i></span>
                        <input type="email" class="form-control" id="email" required placeholder="admin@exemplo.com">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="senha" class="form-label">Senha</label>
                    <div class="input-group">
                        <span class="input-group-text text-muted"><i class="fas fa-key"></i></span>
                        <input type="password" class="form-control" id="senha" required placeholder="********">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('senha', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-danger btn-lg">Entrar</button>
                </div>
                <div class="text-center mt-2">
                    <a href="esqueci-senha.html" class="text-decoration-none small">Esqueci minha senha</a>
                </div>
                <div class="text-center mt-3">
                    <a href="home.html" class="text-decoration-none text-muted"><i class="fas fa-arrow-left"></i> Voltar ao Início</a>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme Logic
        const toggleTheme = () => {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateIcon(newTheme);
        }

        const updateIcon = (theme) => {
            const icon = document.querySelector('#btnTheme i');
            if(icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
        document.addEventListener('DOMContentLoaded', () => updateIcon(savedTheme));

        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        document.getElementById('formLogin').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;

            try {
                const response = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha })
                });

                const result = await response.json();
                if (response.ok) {
                    try {
                        localStorage.setItem('adminToken', result.token);
                        localStorage.setItem('adminRole', result.role);
                        localStorage.setItem('adminId', result.id);
                        localStorage.setItem('primeiroAcesso', result.primeiroAcesso);
                        window.location.href = 'admin.html';
                    } catch (storageError) {
                        console.error(storageError);
                        alert('Erro de permissão: O navegador bloqueou o armazenamento de dados. Se você abriu o arquivo clicando duas vezes (file://), tente usar um servidor local (ex: Live Server) ou verifique as configurações de privacidade.');
                    }
                } else {
                    alert(result.error || 'Falha no login');
                }
            } catch (error) {
                console.error(error);
                alert('Erro de conexão: O servidor backend não está respondendo em localhost:3000. \n\nCertifique-se de que você abriu o terminal e executou o comando: "node server.js"');
            }
        });
    </script>
</body>
</html>