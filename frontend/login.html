<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICASV - Login Administrativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: var(--bs-body-bg);
            background-image: linear-gradient(135deg, rgba(0, 86, 179, 0.05) 0%, rgba(0, 68, 148, 0.1) 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            padding: 1rem; /* Adiciona espaçamento para evitar que o card cole nas bordas */
            transition: background-color 0.3s;
        }
        .card-login { 
            width: 100%; 
            max-width: 420px; 
            border: none; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            border-radius: 1.5rem; 
            overflow: hidden; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        [data-bs-theme="dark"] .card-login {
            background: rgba(33, 37, 41, 0.9);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .logo-area { text-align: center; margin-bottom: 2rem; }
        .logo-icon { font-size: 3.5rem; color: #0056b3; margin-bottom: 10px; }
        [data-bs-theme="dark"] .logo-icon { color: #6ea8fe; }
        .form-control { padding: 0.75rem 1rem; border-radius: 0.5rem; }
        .form-control:focus { box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); border-color: #0d6efd; }
        .input-group-text { background-color: transparent; }
        .btn-login { padding: 0.75rem; font-weight: bold; border-radius: 0.5rem; transition: all 0.3s; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .theme-toggle { position: absolute; top: 20px; right: 20px; }
    </style>
</head>
<body>

    <button class="btn btn-outline-secondary rounded-circle theme-toggle" onclick="toggleTheme()" id="btnTheme"><i class="fas fa-moon"></i></button>

    <div class="card card-login">
        <div class="card-body p-5">
            <div class="logo-area">
                <i class="fas fa-id-card logo-icon"></i>
                <h3 class="fw-bold mb-1">SICASV</h3>
                <p class="text-muted small">Sistema de Cadastro dos Servidores de Venturosa</p>
            </div>
            
            <form id="formLogin">
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="email" placeholder="nome@exemplo.com" required>
                    <label for="email"><i class="fas fa-envelope me-2"></i>Email</label>
                </div>
                
                <div class="mb-4">
                    <div class="input-group">
                        <div class="form-floating flex-grow-1">
                            <input type="password" class="form-control" id="senha" placeholder="Senha" required style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                            <label for="senha"><i class="fas fa-lock me-2"></i>Senha</label>
                        </div>
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('senha', this)" style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="lembrarMe">
                    <label class="form-check-label" for="lembrarMe">Lembrar-me</label>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg btn-login">Acessar Sistema</button>
                </div>
                <div class="text-center mt-2">
                    <a href="esqueci-senha.html" class="text-decoration-none small">Esqueci minha senha</a>
                </div>
                <div class="text-center mt-3">
                    <a href="home.html" class="text-decoration-none text-muted"><i class="fas fa-arrow-left"></i> Voltar ao Início</a>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme Logic
        const toggleTheme = () => {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateIcon(newTheme);
        }

        const updateIcon = (theme) => {
            const icon = document.querySelector('#btnTheme i');
            if(icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
        document.addEventListener('DOMContentLoaded', () => updateIcon(savedTheme));

        // Preencher email se salvo
        const savedEmail = localStorage.getItem('savedEmail');
        if (savedEmail) {
            document.getElementById('email').value = savedEmail;
            document.getElementById('lembrarMe').checked = true;
        }

        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        document.getElementById('formLogin').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const lembrar = document.getElementById('lembrarMe').checked;

            try {
                const response = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha })
                });

                const result = await response.json();
                if (response.ok) {
                    try {
                        const storage = lembrar ? localStorage : sessionStorage;
                        const otherStorage = lembrar ? sessionStorage : localStorage;

                        // Salvar ou limpar email
                        if (lembrar) localStorage.setItem('savedEmail', email);
                        else localStorage.removeItem('savedEmail');

                        // Salvar credenciais no storage escolhido
                        storage.setItem('adminToken', result.token);
                        storage.setItem('adminRole', result.role);
                        storage.setItem('adminId', result.id);
                        storage.setItem('primeiroAcesso', result.primeiroAcesso);

                        // Limpar o outro storage para evitar conflitos
                        otherStorage.removeItem('adminToken');
                        otherStorage.removeItem('adminRole');
                        otherStorage.removeItem('adminId');
                        otherStorage.removeItem('primeiroAcesso');

                        window.location.href = 'admin.html';
                    } catch (storageError) {
                        console.error(storageError);
                        alert('Erro de permissão: O navegador bloqueou o armazenamento de dados. Se você abriu o arquivo clicando duas vezes (file://), tente usar um servidor local (ex: Live Server) ou verifique as configurações de privacidade.');
                    }
                } else {
                    alert(result.error || 'Falha no login');
                }
            } catch (error) {
                console.error(error);
                alert('Erro de conexão: O servidor backend não está respondendo em localhost:3000. \n\nCertifique-se de que você abriu o terminal e executou o comando: "node server.js"');
            }
        });
    </script>
</body>
</html>